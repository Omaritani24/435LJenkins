pipeline {
  agent any

  environment {
    VENV = 'venv'
    ACTIVATE = "%WORKSPACE%\\%VENV%\\Scripts\\activate"
  }

  options { timestamps() }

  stages {

    stage('Setup') {
      steps {
        bat """
          if not exist %VENV% python -m venv %VENV%
          call %ACTIVATE%
          pip install --upgrade pip
          pip install -r requirements.txt
        """
      }
    }

    stage('Lint') {
      steps {
        echo "Running flake8 (lint)..."
        // non-blocking lint so style warnings don't kill the build
        bat "call %ACTIVATE% && flake8 app.py || exit /b 0"
      }
    }

    stage('Test') {
      steps {
        echo "Running pytest..."
        bat """
          call %ACTIVATE%
          set PYTHONPATH=%WORKSPACE%
          pytest -q
        """
      }
    }

    stage('Coverage') {
      steps {
        echo "Running coverage report..."
        bat """
          call %ACTIVATE%
          set PYTHONPATH=%WORKSPACE%
          coverage run -m pytest
          coverage html
          coverage report -m
        """
      }
      post {
        always {
          archiveArtifacts artifacts: 'htmlcov/**', onlyIfSuccessful: false
        }
      }
    }

    stage('Security Scan') {
      steps {
        echo "Running Bandit security scan..."
        bat """
          call %ACTIVATE%
          bandit -r . -f html -o bandit-report.html || exit /b 0
        """
      }
      post {
        always {
          archiveArtifacts artifacts: 'bandit-report.html', onlyIfSuccessful: false
        }
      }
    }

    stage('Deploy') {
      steps {
        echo "Deploying application..."
        bat """
          if exist dist rmdir /s /q dist
          mkdir dist
          copy app.py dist\\
          echo Deployed app.py to dist\\ folder
        """
      }
      post {
        always {
          archiveArtifacts artifacts: 'dist/**', onlyIfSuccessful: false
        }
      }
    }
  }

  post {
    always {
      echo "Cleaning workspace..."
      cleanWs()
    }
  }
}
